name: DEK Rotation

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: "0 2 * * 0"

permissions:
  contents: write
  pull-requests: write

jobs:
  rotate-dek:
    name: Rotate DEK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set date variables
        id: date
        run: |
          echo "date=$(date -u +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          echo "date-formatted=$(date -u +%Y-%m-%dT%H:%MZ)" >> $GITHUB_OUTPUT

      # --- NEW: Check for existing unmerged DEK rotation PR ---
      - name: Check for existing DEK rotation PR
        id: check_pr
        run: |
          existing=$(gh pr list \
            --search "head:dek-rotation" \
            --state open \
            --json number --jq '.[0].number' || true)

          if [ -n "$existing" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Existing PR: #$existing"
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # If PR exists, skip the rest completely
      - name: Stop if PR exists
        if: steps.check_pr.outputs.found == 'true'
        run: |
          echo "A DEK rotation PR is already open. Exiting."
          exit 0

      - name: Rotate DEK
        run: |
          nix develop --command just secrets-rotate-dek
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ðŸ”„ Weekly DEK Rotation - ${{ steps.date.outputs.date-formatted }}"
          body: "Weekly rotation of Data Encryption Keys for all secrets files."
          branch: dek-rotation-${{ steps.date.outputs.date }}
          commit-message: "chore: rotate DEK for all secrets"
          delete-branch: true
